<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>予定一覧（ガントチャート風）</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  padding: 16px;
}
.controls {
  margin-bottom: 12px;
}
.controls label {
  margin-right: 12px;
}
button {
  padding: 4px 10px;
  margin-right: 4px;
  margin-top: 4px;
}
.range {
  font-size: 13px;
  color: #555;
  margin-bottom: 8px;
}
#ganttWrapper {
  overflow-x: auto;
  border: 1px solid #ccc;
}
#gantt {
  position: relative;
  min-height: 40px;
}
.event {
  position: absolute;
  height: 22px;
  border-radius: 4px;
  font-size: 12px;
  padding: 2px 4px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  background: #3399ff;
  color: white;
}
.memo {
  background: #ffcc00;
  color: #000;
}
#memoArea {
  margin-top: 16px;
}
</style>
</head>

<body>
<h2>予定一覧（ガントチャート風）</h2>

<div class="range" id="rangeInfo">読込中…</div>

<div class="controls">
  <label>開始日 <input type="date" id="startDate"></label>
  <label>終了日 <input type="date" id="endDate"></label>

  <button id="todayBtn">今日</button>
  <button id="weekBtn">今週</button>
  <button id="monthBtn">今月</button>
  <button id="allBtn">全期間</button>
  <button id="memoBtn">メモ一覧</button>
  <button id="loadBtn">表示</button>
</div>

<div id="ganttWrapper">
  <div id="gantt"></div>
</div>

<div id="memoArea" style="display:none"></div>

<script>
const WORKER_URL = "https://get-gcalschedule.t-osato.workers.dev/"; // Cloudflare Worker URL
const DAY_WIDTH = 80;

const gantt = document.getElementById("gantt");
const memoArea = document.getElementById("memoArea");
const rangeInfo = document.getElementById("rangeInfo");
const startInput = document.getElementById("startDate");
const endInput = document.getElementById("endDate");

let events = [];
let minDate, maxDate;

init();

async function init() {
  const text = await (await fetch(WORKER_URL)).text();
  const blocks = text.split("BEGIN:VEVENT").slice(1);

  events = blocks.map(b => {
    const get = r => (b.match(r)||[])[1]||"";
    return {
      start: get(/DTSTART[^:]*:(\d{8}(?:T\d{6})?)/),
      end:   get(/DTEND[^:]*:(\d{8}(?:T\d{6})?)/),
      title: get(/SUMMARY:(.+)/),
      memo:  get(/DTSTART[^:]*:(\d{8})/)[1] === "99991231"
    };
  });

  const dates = events.filter(e=>!e.memo).map(e=>e.start.slice(0,8));
  minDate = dates.sort()[0];
  maxDate = dates.sort().slice(-1)[0];

  rangeInfo.textContent = `期間：${fmt(minDate)} ～ ${fmt(maxDate)}`;
  startInput.value = fmt(minDate);
  endInput.value = fmt(maxDate);
}

document.getElementById("allBtn").onclick = ()=>{
  startInput.value = fmt(minDate);
  endInput.value = fmt(maxDate);
};
document.getElementById("todayBtn").onclick = ()=>{
  const t = ymd(new Date());
  startInput.value = fmt(t);
  endInput.value = fmt(t);
};
document.getElementById("weekBtn").onclick = ()=>{
  const d=new Date();const w=d.getDay();d.setDate(d.getDate()-(w===0?6:w-1));
  startInput.value=fmt(ymd(d));d.setDate(d.getDate()+6);endInput.value=fmt(ymd(d));
};
document.getElementById("monthBtn").onclick = ()=>{
  const d=new Date();startInput.value=fmt(ymd(new Date(d.getFullYear(),d.getMonth(),1)));
  endInput.value=fmt(ymd(new Date(d.getFullYear(),d.getMonth()+1,0)));
};

document.getElementById("memoBtn").onclick = ()=>{
  gantt.innerHTML="";
  memoArea.style.display="block";
  memoArea.innerHTML="<h3>メモ一覧</h3>";
  events.filter(e=>e.memo).forEach(e=>{
    const d=document.createElement("div");
    d.className="event memo";
    d.textContent=e.title;
    d.style.position="static";
    memoArea.appendChild(d);
  });
};

document.getElementById("loadBtn").onclick = render;

function render(){
  memoArea.style.display="none";
  gantt.innerHTML="";
  const s = startInput.value.replace(/-/g,"");
  const e = endInput.value.replace(/-/g,"");

  let row=0;
  events.filter(ev=>!ev.memo && ev.start.slice(0,8)>=s && ev.start.slice(0,8)<=e)
    .forEach(ev=>{
      const left = (ev.start.slice(0,8)-s)/1 * DAY_WIDTH;
      const width = DAY_WIDTH;
      const el=document.createElement("div");
      el.className="event";
      el.style.left=left+"px";
      el.style.top=(row++*26)+"px";
      el.style.width=width+"px";
      el.textContent=ev.title;
      gantt.appendChild(el);
    });

  gantt.style.width=((e-s+1)*DAY_WIDTH)+"px";
  gantt.style.height=(row*26+10)+"px";
}

function fmt(ymd){return `${ymd.slice(0,4)}-${ymd.slice(4,6)}-${ymd.slice(6,8)}`;}
function ymd(d){return d.getFullYear().toString().padStart(4,'0')+(d.getMonth()+1).toString().padStart(2,'0')+d.getDate().toString().padStart(2,'0');}
</script>
</body>
</html>
