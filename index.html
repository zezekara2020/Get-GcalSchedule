<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>予定一覧（カレンダー風）</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  padding: 16px;
}
.controls {
  margin-bottom: 12px;
}
.controls label {
  margin-right: 12px;
}
.controls input[type="text"], .controls input[type="date"] {
  width: 180px;
}
button {
  padding: 4px 10px;
  margin-right: 4px;
  margin-top: 4px;
}
.range {
  font-size: 13px;
  color: #555;
  margin-bottom: 8px;
}
#calendar {
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.day-block {
  border: 1px solid #ccc;
  padding: 6px;
  border-radius: 4px;
  background: #fafafa;
}
.day-block .date {
  font-weight: bold;
  margin-bottom: 4px;
}
.event {
  margin-left: 10px;
  padding: 2px 4px;
  border-radius: 3px;
  margin-bottom: 2px;
}
.event.memo {
  background: #fffae6;
  border-left: 4px solid #ffcc00;
}
.event.normal {
  background: #e6f0ff;
  border-left: 4px solid #3399ff;
}
@media (max-width: 480px) {
  .controls label, .controls input, .controls button {
    display: block;
    margin-bottom: 8px;
  }
  .controls input[type="text"], .controls input[type="date"] {
    width: 100%;
  }
}
</style>
</head>

<body>
<h2>予定一覧（カレンダー風）</h2>

<div class="range" id="rangeInfo">ICSの有効期間を取得中…</div>

<div class="controls">
  <label>開始日：
    <input type="date" id="startDate" disabled>
  </label>
  <label>終了日：
    <input type="date" id="endDate" disabled>
  </label>

  <button id="todayBtn" disabled>今日</button>
  <button id="weekBtn" disabled>今週</button>
  <button id="monthBtn" disabled>今月</button>
  <button id="allBtn" disabled>全期間</button>
  <button id="memoBtn" disabled>メモ一覧</button>

  <label>検索：
    <input type="text" id="keyword" placeholder="件名・場所">
  </label>
  <button id="loadBtn" disabled>データ読込</button>
</div>

<div id="calendar">初期化中…</div>

<script>
const WORKER_URL = "https://get-gcalschedule.t-osato.workers.dev/"; // Cloudflare Worker URL

const startInput = document.getElementById("startDate");
const endInput   = document.getElementById("endDate");
const keywordInput = document.getElementById("keyword");
const loadBtn    = document.getElementById("loadBtn");
const todayBtn   = document.getElementById("todayBtn");
const weekBtn    = document.getElementById("weekBtn");
const monthBtn   = document.getElementById("monthBtn");
const allBtn     = document.getElementById("allBtn");
const memoBtn    = document.getElementById("memoBtn");
const calendarEl = document.getElementById("calendar");
const rangeInfo  = document.getElementById("rangeInfo");

let cachedICS = null;
let minDate = null;
let maxDate = null;

// 初期化
init();

async function init() {
  try {
    const res = await fetch(WORKER_URL);
    const text = await res.text();

    const normalized = text.replace(/\r?\n[ \t]/g, "");
    cachedICS = normalized;

    const events = normalized.split("BEGIN:VEVENT").slice(1);

    minDate = null;
    maxDate = null;

    events.forEach(block => {
      const m = block.match(/DTSTART[^:]*:(\d{8})/);
      if (!m) return;
      const date = m[1];
      if (date === "99991231") return; // メモ除外
      if (!minDate || date < minDate) minDate = date;
      if (!maxDate || date > maxDate) maxDate = date;
    });

    if (!minDate || !maxDate) {
      rangeInfo.textContent = "ICS内に予定が見つかりません";
      return;
    }

    rangeInfo.textContent = `ICSの有効期間：${formatYMD(minDate)} ～ ${formatYMD(maxDate)}`;

    startInput.min = formatYMD(minDate);
    startInput.max = formatYMD(maxDate);
    endInput.min   = formatYMD(minDate);
    endInput.max   = formatYMD(maxDate);

    startInput.value = formatYMD(minDate);
    endInput.value   = formatYMD(maxDate);

    startInput.disabled = false;
    endInput.disabled   = false;
    loadBtn.disabled    = false;
    todayBtn.disabled   = false;
    weekBtn.disabled    = false;
    monthBtn.disabled   = false;
    allBtn.disabled     = false;
    memoBtn.disabled    = false;

    calendarEl.textContent = "条件を指定して「データ読込」または「メモ一覧」を押してください";

  } catch (err) {
    rangeInfo.textContent = "ICSの初期化に失敗しました";
    console.error(err);
  }
}

function formatYMD(yyyymmdd) {
  return `${yyyymmdd.slice(0,4)}-${yyyymmdd.slice(4,6)}-${yyyymmdd.slice(6,8)}`;
}

function toYMD(dateStr) {
  return dateStr.replace(/-/g, "");
}

function dateToYMD(d) {
  return d.getFullYear().toString().padStart(4,'0') +
         (d.getMonth()+1).toString().padStart(2,'0') +
         d.getDate().toString().padStart(2,'0');
}

function clampYMD(ymd) {
  if (ymd < minDate) return minDate;
  if (ymd > maxDate) return maxDate;
  return ymd;
}

// ボタン処理
todayBtn.addEventListener("click", () => {
  const today = dateToYMD(new Date());
  startInput.value = formatYMD(clampYMD(today));
  endInput.value   = formatYMD(clampYMD(today));
});
weekBtn.addEventListener("click", () => {
  const now = new Date();
  const day = now.getDay();
  const mondayOffset = (day === 0 ? -6 : 1) - day;
  const start = new Date(now); start.setDate(now.getDate() + mondayOffset);
  const end = new Date(start); end.setDate(start.getDate() + 6);
  startInput.value = formatYMD(clampYMD(dateToYMD(start)));
  endInput.value   = formatYMD(clampYMD(dateToYMD(end)));
});
monthBtn.addEventListener("click", () => {
  const now = new Date();
  const start = new Date(now.getFullYear(), now.getMonth(), 1);
  const end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
  startInput.value = formatYMD(clampYMD(dateToYMD(start)));
  endInput.value   = formatYMD(clampYMD(dateToYMD(end)));
});
allBtn.addEventListener("click", () => {
  startInput.value = formatYMD(minDate);
  endInput.value   = formatYMD(maxDate);
});

// メモ一覧
memoBtn.addEventListener("click", () => {
  renderEvents(true);
});

// データ読込
loadBtn.addEventListener("click", () => {
  renderEvents(false);
});

function renderEvents(showMemoOnly) {
  const startYMD = showMemoOnly ? null : toYMD(startInput.value);
  const endYMD   = showMemoOnly ? null : toYMD(endInput.value);
  const keyword  = keywordInput.value.trim().toLowerCase();

  const events = cachedICS.split("BEGIN:VEVENT").slice(1);
  const grouped = {};

  events.forEach(block => {
    const get = re => (block.match(re) || [])[1]?.trim() || "";
    const summary  = get(/SUMMARY:(.+)/);
    const location = get(/LOCATION:(.+)/);
    const startRaw = get(/DTSTART[^:]*:(\d{8}(?:T\d{6})?)/);

    if (!startRaw) return;
    const ymd = startRaw.slice(0,8);
    const isMemo = ymd === "99991231";

    if (showMemoOnly && !isMemo) return;
    if (!showMemoOnly && isMemo) return;
    if (!showMemoOnly && (ymd < startYMD || ymd > endYMD)) return;
    if (keyword && !`${summary} ${location}`.toLowerCase().includes(keyword)) return;

    if (!grouped[ymd]) grouped[ymd] = [];
    grouped[ymd].push({summary, location, memo: isMemo, startRaw});
  });

  if (Object.keys(grouped).length === 0) {
    calendarEl.textContent = showMemoOnly ? "メモはありません" : "条件に一致する予定はありません";
    return;
  }

  // 日付順に描画
  const sortedDates = Object.keys(grouped).sort();
  calendarEl.innerHTML = "";
  sortedDates.forEach(d => {
    const block = document.createElement("div");
    block.className = "day-block";
    block.innerHTML = `<div class="date">${d}</div>`;

    grouped[d].forEach(ev => {
      const evEl = document.createElement("div");
      evEl.className = `event ${ev.memo ? "memo" : "normal"}`;
      let text = "";
      if (!ev.memo && ev.startRaw.includes("T")) {
        text += `${ev.startRaw.slice(9,11)}:${ev.startRaw.slice(11,13)}-`;
        const endRaw = block.match(/DTEND[^:]*:(\d{8}(?:T\d{6})?)/)?.[1] || "";
        if (endRaw) text += `${endRaw.slice(9,11)}:${endRaw.slice(11,13)} `;
      }
      text += ev.summary || "";
      if (ev.location) text += ` @${ev.location}`;
      evEl.textContent = text;
      block.appendChild(evEl);
    });

    calendarEl.appendChild(block);
  });
}
</script>
</body>
</html>
