<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>予定一覧</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  padding: 16px;
}
.range {
  font-size: 13px;
  color: #555;
  margin-bottom: 8px;
}
.controls {
  margin-bottom: 12px;
}
.controls label {
  margin-right: 12px;
}
.controls input[type="date"], .controls input[type="text"] {
  width: 180px;
}
button {
  padding: 4px 10px;
  margin-right: 4px;
  margin-top: 4px;
}
pre {
  white-space: pre-wrap;
  background: #f6f6f6;
  padding: 12px;
  font-size: 14px;
}
@media (max-width: 480px) {
  .controls label, .controls input, .controls button {
    display: block;
    margin-bottom: 8px;
  }
  .controls input {
    width: 100%;
  }
}
</style>
</head>

<body>
<h2>予定一覧</h2>

<div class="range" id="rangeInfo">読込中…</div>

<div class="controls">
  <label>開始日：
    <input type="date" id="startDate" disabled>
  </label>
  <label>終了日：
    <input type="date" id="endDate" disabled>
  </label>

  <button id="todayBtn" disabled>今日</button>
  <button id="weekBtn" disabled>今週</button>
  <button id="monthBtn" disabled>今月</button>
  <button id="allBtn" disabled>全期間</button>
  <button id="memoBtn" disabled>メモ一覧</button>

  <label>検索：
    <input type="text" id="keyword" placeholder="件名">
  </label>
  <button id="loadBtn" disabled>表示</button>
  <button id="copyBtn" disabled>コピー</button>
</div>

<pre id="out">初期化中…</pre>

<script>
const WORKER_URL = "https://get-gcalschedule.t-osato.workers.dev/"; // Cloudflare Worker URL
const startInput = document.getElementById("startDate");
const endInput   = document.getElementById("endDate");
const keywordInput = document.getElementById("keyword");
const output     = document.getElementById("out");

const todayBtn = document.getElementById("todayBtn");
const weekBtn  = document.getElementById("weekBtn");
const monthBtn = document.getElementById("monthBtn");
const allBtn   = document.getElementById("allBtn");
const memoBtn  = document.getElementById("memoBtn");
const loadBtn  = document.getElementById("loadBtn");
const copyBtn  = document.getElementById("copyBtn");
const rangeInfo = document.getElementById("rangeInfo");

let cachedICS = "";
let minDate = null;
let maxDate = null;

init();

/* ---------- 初期化 ---------- */
async function init() {
  const res = await fetch(WORKER_URL);
  cachedICS = (await res.text()).replace(/\r?\n[ \t]/g, "");

  const events = cachedICS.split("BEGIN:VEVENT").slice(1);

  events.forEach(b => {
    const m = b.match(/DTSTART[^:]*:(\d{8})/);
    if (!m) return;
    if (m[1] === "99991231") return;
    if (!minDate || m[1] < minDate) minDate = m[1];
    if (!maxDate || m[1] > maxDate) maxDate = m[1];
  });

  rangeInfo.textContent = `期間：${fmt(minDate)} ～ ${fmt(maxDate)}`;

  startInput.min = endInput.min = fmt(minDate);
  startInput.max = endInput.max = fmt(maxDate);
  startInput.value = fmt(minDate);
  endInput.value   = fmt(maxDate);

  [startInput, endInput, todayBtn, weekBtn, monthBtn, allBtn, memoBtn, loadBtn]
    .forEach(e => e.disabled = false);

  output.textContent = "条件を指定して「表示」を押してください";
}

/* ---------- 日付操作 ---------- */
todayBtn.onclick = () => {
  const t = ymd(new Date());
  startInput.value = endInput.value = fmt(clamp(t));
};
weekBtn.onclick = () => {
  const d = new Date();
  const w = d.getDay();
  d.setDate(d.getDate() - (w === 0 ? 6 : w - 1));
  startInput.value = fmt(clamp(ymd(d)));
  d.setDate(d.getDate() + 6);
  endInput.value = fmt(clamp(ymd(d)));
};
monthBtn.onclick = () => {
  const d = new Date();
  startInput.value = fmt(clamp(ymd(new Date(d.getFullYear(), d.getMonth(), 1))));
  endInput.value   = fmt(clamp(ymd(new Date(d.getFullYear(), d.getMonth()+1, 0))));
};
allBtn.onclick = () => {
  startInput.value = fmt(minDate);
  endInput.value   = fmt(maxDate);
};

/* ---------- 表示 ---------- */
loadBtn.onclick = () => render(false);
memoBtn.onclick = () => render(true);

function render(showMemo) {
  copyBtn.disabled = true;

  const s = startInput.value.replace(/-/g,"");
  const e = endInput.value.replace(/-/g,"");
  const key = keywordInput.value.toLowerCase();

  const lines = [];

  cachedICS.split("BEGIN:VEVENT").slice(1).forEach(b => {
    const get = r => (b.match(r)||[])[1] || "";
    const start = get(/DTSTART[^:]*:(\d{8}(?:T\d{6})?)/);
    const end   = get(/DTEND[^:]*:(\d{8}(?:T\d{6})?)/);
    const title = get(/SUMMARY:(.+)/);

    if (!start || !end) return;

    const ymd8 = start.slice(0,8);
    const isMemo = ymd8 === "99991231";

    if (showMemo !== isMemo) return;
    if (!showMemo && (ymd8 < s || ymd8 > e)) return;
    if (key && !title.toLowerCase().includes(key)) return;

    let startTime = "00:00";
    let endTime   = "24:00";

    if (start.includes("T")) {
      startTime = `${start.slice(9,11)}:${start.slice(11,13)}`;
      endTime   = `${end.slice(9,11)}:${end.slice(11,13)}`;
    }

    lines.push({
      key: `${ymd8}${startTime}`,
      text: `${fmt(ymd8)} ${startTime}${title}${endTime}`
    });
  });

  lines.sort((a,b)=>a.key.localeCompare(b.key));

  output.textContent = lines.length
    ? lines.map(l=>l.text).join("\n")
    : (showMemo ? "メモはありません" : "条件に一致する予定はありません");

  if (lines.length) copyBtn.disabled = false;
}

/* ---------- コピー ---------- */
copyBtn.onclick = async () => {
  const text = output.textContent
    .split("\n")
    .map(line => line.slice(11)) // yyyy-mm-dd + space を削除
    .join("\n");

  await navigator.clipboard.writeText(text);
  alert("コピーしました");
};

/* ---------- util ---------- */
function fmt(ymd){return `${ymd.slice(0,4)}-${ymd.slice(4,6)}-${ymd.slice(6,8)}`;}
function ymd(d){return d.getFullYear().toString().padStart(4,'0')+(d.getMonth()+1).toString().padStart(2,'0')+d.getDate().toString().padStart(2,'0');}
function clamp(v){return v<minDate?minDate:v>maxDate?maxDate:v;}
</script>
</body>
</html>
