<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>予定一覧</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  padding: 16px;
}
.range {
  font-size: 13px;
  color: #555;
  margin-bottom: 8px;
}
.controls {
  margin-bottom: 12px;
}
.controls label {
  margin-right: 12px;
}
.controls input[type="text"], .controls input[type="date"] {
  width: 200px;
}
button {
  padding: 4px 10px;
  margin-right: 4px;
  margin-top: 4px;
}
pre {
  white-space: pre-wrap;
  font-size: 14px;
  background: #f6f6f6;
  padding: 12px;
}
@media (max-width: 480px) {
  .controls label, .controls input, .controls button {
    display: block;
    margin-bottom: 8px;
  }
  .controls input[type="text"], .controls input[type="date"] {
    width: 100%;
  }
}
</style>
</head>

<body>
<h2>予定一覧</h2>

<div class="range" id="rangeInfo">ICSの有効期間を取得中…</div>

<div class="controls">
  <label>開始日：
    <input type="date" id="startDate" disabled>
  </label>
  <label>終了日：
    <input type="date" id="endDate" disabled>
  </label>

  <button id="todayBtn" disabled>今日</button>
  <button id="weekBtn" disabled>今週</button>
  <button id="monthBtn" disabled>今月</button>

  <label>検索：
    <input type="text" id="keyword" placeholder="件名・場所">
  </label>
  <button id="loadBtn" disabled>データ読込</button>
</div>

<pre id="out">初期化中…</pre>

<script>
const WORKER_URL = "https://get-gcalschedule.t-osato.workers.dev/"; // Cloudflare Worker URL
const startInput = document.getElementById("startDate");
const endInput   = document.getElementById("endDate");
const keywordInput = document.getElementById("keyword");
const loadBtn    = document.getElementById("loadBtn");
const todayBtn   = document.getElementById("todayBtn");
const weekBtn    = document.getElementById("weekBtn");
const monthBtn   = document.getElementById("monthBtn");
const output     = document.getElementById("out");
const rangeInfo  = document.getElementById("rangeInfo");

let cachedICS = null;
let minDate = null;
let maxDate = null;

// 初期化
init();

async function init() {
  try {
    const res = await fetch(WORKER_URL);
    const text = await res.text();

    const normalized = text.replace(/\r?\n[ \t]/g, "");
    cachedICS = normalized;

    const events = normalized.split("BEGIN:VEVENT").slice(1);

    events.forEach(block => {
      const m = block.match(/DTSTART[^:]*:(\d{8})/);
      if (!m) return;
      const date = m[1]; // YYYYMMDD
      if (!minDate || date < minDate) minDate = date;
      if (!maxDate || date > maxDate) maxDate = date;
    });

    if (!minDate || !maxDate) {
      rangeInfo.textContent = "ICS内に予定が見つかりません";
      return;
    }

    rangeInfo.textContent = `ICSの有効期間：${formatYMD(minDate)} ～ ${formatYMD(maxDate)}`;

    startInput.min = formatYMD(minDate);
    startInput.max = formatYMD(maxDate);
    endInput.min   = formatYMD(minDate);
    endInput.max   = formatYMD(maxDate);

    startInput.value = formatYMD(minDate);
    endInput.value   = formatYMD(maxDate);

    startInput.disabled = false;
    endInput.disabled   = false;
    loadBtn.disabled    = false;
    todayBtn.disabled   = false;
    weekBtn.disabled    = false;
    monthBtn.disabled   = false;

    output.textContent = "条件を指定して「データ読込」を押してください";

  } catch (err) {
    rangeInfo.textContent = "ICSの初期化に失敗しました";
    console.error(err);
  }
}

// YYYYMMDD → yyyy-mm-dd
function formatYMD(yyyymmdd) {
  return `${yyyymmdd.slice(0,4)}-${yyyymmdd.slice(4,6)}-${yyyymmdd.slice(6,8)}`;
}

// yyyy-mm-dd → YYYYMMDD
function toYMD(dateStr) {
  return dateStr.replace(/-/g, "");
}

// 今日
todayBtn.addEventListener("click", () => {
  const today = new Date();
  const ymd = today.getFullYear().toString().padStart(4,'0') +
              (today.getMonth()+1).toString().padStart(2,'0') +
              today.getDate().toString().padStart(2,'0');
  const clamped = clampYMD(ymd);
  startInput.value = formatYMD(clamped);
  endInput.value   = formatYMD(clamped);
});

// 今
